var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{},t={},r={},o=e.parcelRequire7b01;null==o&&((o=function(e){if(e in t)return t[e].exports;if(e in r){var o=r[e];delete r[e];var s={id:e,exports:{}};return t[e]=s,o.call(s.exports,s,s.exports),s.exports}var l=Error("Cannot find module '"+e+"'");throw l.code="MODULE_NOT_FOUND",l}).register=function(e,t){r[e]=t},e.parcelRequire7b01=o),o.register;var s=o("ahdtQ"),l=o("8zzUU"),a=o("8HyT0"),s=o("ahdtQ");const n=new class{constructor(e=s.default.INITIAL_STATE){this.gameContext={state:e,score:0,status:s.default.STATUS.idle,movePossible:!0,moves:0}}moveLeft(){return this.move(s.default.DIRECTION.left)}moveRight(){return this.move(s.default.DIRECTION.right)}moveUp(){return this.move(s.default.DIRECTION.up)}moveDown(){return this.move(s.default.DIRECTION.down)}getScore(){return this.gameContext.score}getState(){return Array.from(this.gameContext.state).map(e=>Array.from(e))}getStatus(){return this.getGameContext().status}start(){this.updateGameContext({status:s.default.STATUS.playing}),this.addRandomCellValue(),this.addRandomCellValue()}restart(){this.updateGameContext({score:0,state:s.default.INITIAL_STATE,status:s.default.STATUS.playing}),this.addRandomCellValue(),this.addRandomCellValue()}win(){this.updateGameContext({status:s.default.STATUS.win})}lose(){this.updateGameContext({status:s.default.STATUS.lose})}getMoves(){return this.getGameContext().moves}getGameContext(){return this.gameContext}canMoveOrMergeCells(e,t){return 0===e&&0!==t||(0!==e||0!==t)&&e===t}stateHasZeroes(){return this.getState().some(e=>e.some(e=>0===e))}mergeIsPossible(){let e=this.getState();for(let t=0;t<e.length;t++)for(let r=0;r<e[t].length;r++){let o=e[t][r],s=e[t][r+1];if(s&&o===s)return!0;if(t===e.length-1)continue;let l=e[t+1][r];if(l&&o===l)return!0}return!1}checkIfLost(){return!this.stateHasZeroes()&&!this.mergeIsPossible()}checkAvailableMovesOnSingleLine(e){for(let t=0;t<e.length;t++)for(let r=0;r<e[t].length-1;r++){let o=e[t][r],s=e[t][r+1];if(this.canMoveOrMergeCells(o,s))return!0}return!1}updateGameContext(e){Object.entries(e).forEach(e=>{let t=e[0],r=e[1];this.gameContext[t]=r})}reverseStateByAxis(e){return Array.from(e.map(e=>Array.from(e).reverse()))}transformStatePerDirection(e,t){switch(t){case s.default.DIRECTION.left:return e;case s.default.DIRECTION.right:return this.reverseStateByAxis(e);case s.default.DIRECTION.up:return this.transposeState(e,!1);case s.default.DIRECTION.down:return this.transposeState(e,!0)}}transposeState(e,t=!1){let r=Array.from(e).map(e=>Array.from(e));return e.forEach((e,t)=>{e.forEach((e,o)=>{r[o][t]=e})}),t?r.reverse().map(e=>e.reverse()):r}removeZeroes(e){return Array.from(e).map(e=>Array.from(e).filter(e=>0!==e))}fillWithZeroes(e){return Array.from(e).map(e=>{if(!(e.length<s.default.FIELD_SIZE))return Array.from(e);{let t=Array.from(e);return t.length=s.default.FIELD_SIZE,t.fill(0,e.length,s.default.FIELD_SIZE)}})}moveAndMergeTiles(e){let t=Array.from(e),r=0;for(let o=0;o<e.length;o++)for(let l=0;l<e[o].length-1;l++){let a=e[o][l],n=e[o][l+1];if(0!==a&&a===n){let e=2*a;e===s.default.WIN_VALUE&&this.updateGameContext({status:s.default.STATUS.win}),r+=e,t[o][l]=e,t[o][l+1]=0}}return{score:r,stateWithMergedTiles:this.removeZeroes(t)}}selectMoveFunction(e){return({left:this.moveLeft.bind(this),right:this.moveRight.bind(this),up:this.moveUp.bind(this),down:this.moveDown.bind(this)})[e]}move(e){let t=this.transformStatePerDirection(this.getState(),e);if(this.updateGameContext({movePossible:this.checkAvailableMovesOnSingleLine(t)}),!this.getGameContext().movePossible)return!1;let r=this.removeZeroes(t),{score:o,stateWithMergedTiles:s}=this.moveAndMergeTiles(r),l=this.fillWithZeroes(s),a=this.transformStatePerDirection(l,e);return this.updateGameContext({score:this.getScore()+o,state:a,moves:this.getGameContext().moves+=1}),!0}isTimeForFourTile(){return Math.random()<s.default.PROBABILITY_FOR_FOUR}randomlyChangeNumberWithProbability(e,t){let r=Math.random();return r<t?r:e}addRandomCellValue(){let e=this.getState(),t=Array.from(e).map(e=>Array.from(e)),r=1,o=()=>1/r,s=-1,l=-1,a=-1;for(let t=0;t<e.length;t++)for(let n=0;n<e[t].length;n++){if(0!==e[t][n])continue;let i=this.randomlyChangeNumberWithProbability(a,o());i!==a&&(a=i,s=t,l=n),r++}if(-1===s||-1===l||void 0===t[s][l])return{failedToAdd:!0};let n=this.isTimeForFourTile()?4:2;return 0===t[s][l]?(t[s][l]=n,this.updateGameContext({state:t}),{failedToAdd:!1,row:s,col:l,value:n}):{failedToAdd:!0}}},i=document.querySelector(".game-field"),d=document.querySelector(".game-score"),u=e=>{for(let t of e.classList)"field-cell"!==t&&e.classList.remove(t)},f=()=>{let e=n.getState(),t=i.rows;for(let r=0;r<e.length;r++){let o=t[r].cells,s=e[r];for(let e=0;e<o.length;e++){let t=s[e],r=o[e];u(r),0!==t?(r.innerHTML=t,r.classList.add("field-cell--"+t)):r.innerHTML=""}}d.innerHTML=n.getScore()},m=e=>{let{failedToAdd:t,row:r,col:o,value:s}=e;if(t)return;let l=i.rows[r].cells[o];l&&(l.innerHTML=s,l.classList.add("field-cell--"+s))},h=document.querySelector(".start"),c=document.querySelector(".restart"),g=()=>{(0,a.default).switchButtons(".restart"),(0,a.default).makeMessageVisible(".message-restart")},S=e=>{e===s.default.STATUS.win&&(0,a.default).makeMessageVisible(".message-win"),e===s.default.STATUS.lose&&(0,a.default).makeMessageVisible(".message-lose"),e!==s.default.STATUS.playing&&(0,a.default).defocusField(),A()},T=e=>{n.getStatus()!==s.default.STATUS.win&&n.getStatus()!==s.default.STATUS.lose&&new Promise((t,r)=>{n.checkIfLost()&&r(Error(s.default.STATUS.lose)),n.selectMoveFunction(e)()?t("Moved"):r(Error("Move failed"))}).then(e=>{if(console.log(e),f(),1===n.getMoves()&&g(),n.getStatus()===s.default.STATUS.win){S(s.default.STATUS.win);return}setTimeout(()=>m(n.addRandomCellValue()),300)}).catch(e=>{console.log({err:e}),e.message===s.default.STATUS.lose&&S(s.default.STATUS.lose),"Move failed"===e.message&&console.log(e.message)})},v=e=>{let t=e.key;t&&(0,l.keyController).arrowKeys.hasOwnProperty(t)&&T((0,l.keyController).identifyArrowKeyDirection(t))},p=e=>{T((0,l.swipeController).handleTouchEnd(e))},C=()=>{document.addEventListener("keydown",v),i.addEventListener("touchstart",(0,l.swipeController).handleTouchStart.bind(l.swipeController)),i.addEventListener("touchend",p),i.addEventListener("touchmove",(0,l.swipeController).preventScrollOnSwipe.bind(l.swipeController))},A=()=>{document.removeEventListener("keydown",v),i.removeEventListener("touchstart",(0,l.swipeController).handleTouchStart.bind(l.swipeController)),i.removeEventListener("touchend",p),i.removeEventListener("touchmove",(0,l.swipeController).preventScrollOnSwipe.bind(l.swipeController))};h.addEventListener("click",()=>{n.getStatus()!==s.default.STATUS.playing&&(C(),n.start(),(0,a.default).focusField(),f())}),c.addEventListener("click",()=>{A(),C(),(0,a.default).makeMessageVisible(".message-restart"),n.restart(),f(),(0,a.default).focusField()});
//# sourceMappingURL=index.3eb5e11a.js.map
